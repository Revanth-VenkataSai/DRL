import os
import time
import psycopg2 as ps2
import pandas as pd
from os import path

#Database Connection
conn = ps2.connect(host = host, 
                        port = port, 
                        database = database, 
                        user= user, 
                        password = pwd)

def query_fetch(query,conn):
    df = pd.read_sql_query(query,conn)
    return df

#Omez Analysis - Sales Query
omez_Sales_query = '''select extract(year from foc.order_placed_at)  as "year", extract(month from foc.order_placed_at) as month_num, to_char(foc.order_placed_at, 'Month') AS Month_name, sum(mnql.quantity) as Quantity_Sold, sum(mnql.unit_mrp * mnql.quantity) as GMV, count(distinct foc.customer_id) as customers from data_model.f_order_consumer foc left join data_model.f_order fo on fo.order_id = foc.order_id left join pe_pe2_pe2.medicine_notes mn on mn.order_id = fo.order_id left join pe_pe2_pe2.medicine_notes_product_info mnpi on mnpi.medicine_notes_id = mn.id left join pe_pe2_pe2.medicine_notes_quantity_log mnql on mnql.medicine_notes_id = mn.id left join data_model.d_catalog_product dcp on dcp.ucode = mn.ucode where foc.order_status_id in(9,10) AND dcp.ucode IN ('130875', '130876', '130885', '130890', '130900', '130905', '196203', 'I00600', 'I06693', 'I18689') and extract(year from foc.order_placed_at) in ( 2020,2021) group by 1,2,3 order by 1,2; '''
#Competitor Analysis - Sales Query
comp_sales_query = '''select extract(year from foc.order_placed_at)  as "year", extract(month from foc.order_placed_at) as month_num, to_char(foc.order_placed_at, 'Month') AS Month_name, sum(mnql.quantity) as Quantity_Sold, sum(mnql.unit_mrp * mnql.quantity) as GMV, count(distinct foc.customer_id) as customers from data_model.f_order_consumer foc left join data_model.f_order fo on fo.order_id = foc.order_id left join pe_pe2_pe2.medicine_notes mn on mn.order_id = fo.order_id left join pe_pe2_pe2.medicine_notes_product_info mnpi on mnpi.medicine_notes_id = mn.id left join pe_pe2_pe2.medicine_notes_quantity_log mnql on mnql.medicine_notes_id = mn.id left join data_model.d_catalog_product dcp on dcp.ucode = mn.ucode where foc.order_status_id in(9,10) AND dcp.ucode IN ('274085',	'302217',	'I40963',	'I18670',	'278445',	'220650',	'I41311',	'320527',	'206267',	'199344',	'36821',	'300250',	'284067',	'256947',	'219202',	'327847',	'130990',	'130806',	'108790',	'I18678',	'210722',	'288836',	'202063',	'296574',	'176680','130485',	'U27831',	'I15105',	'304089',	'I06693',	'325512',	'72585',	'200270',	'268389',	'131930',	'274045',	'271406',	'K86651',	'293205',	'215227',	'V84647',	'160270',	'266941',	'318467',	'130815',	'211197',	'200266',	'280999',	'288238',	'I18679',	'221767',	'269521',	'59960',	'131925',	'I18688',	'287242',	'I40697',	'106620',	'205196',	'330915',	'153825',	'323272',	'I18677',	'244639',	'130915',	'I07092',	'190580',	'202081',	'176690',	'267864',	'I18664',	'258664',	'291942',	'290692',	'299572',	'I18683',	'131935',	'312938',	'202082',	'293473',	'280964',	'143295',	'193501',	'128109',	'269180',	'I14798',	'249399',	'I18668',	'196203',	'I18687',	'316649',	'209020',	'268677',	'257572',	'144190',	'263591',	'267479',	'199320',	'330276',	'224710',	'25375',	'129715',	'130876',	'130800',	'325837',	'197465',	'I09663',	'252310',	'270854',	'106625',	'64649',	'229086',	'130855',	'315689',	'144730',	'218302',	'128125',	'130820',	'247298',	'281507',	'265907',	'258812',	'128130',	'I18684',	'130890',	'199233',	'212978',	'206001',	'130730',	'276079',	'130780',	'I18691',	'287803',	'131015',	'206111',	'130925',	'309302',	'299604',	'128110',	'I19111',	'113435',	'130880',	'130895',	'I04595',	'290522',	'324065',	'207459',	'320085',	'I44728',	'I37767',	'255918',	'255793',	'219203',	'143210',	'195208',	'I18690',	'207649',	'368881',	'271710',	'248853',	'107145',	'288676',	'291505',	'202217',	'19355',	'200269',	'33055',	'327767',	'I05335',	'I18692',	'I18659',	'184420',	'205658',	'I18666',	'382533',	'133510',	'212295',	'I13486',	'128105',	'V31842',	'307085',	'T38748',	'285263',	'329174',	'130715',	'251441',	'I18686',	'262082',	'258505',	'266943',	'205568',	'280127',	'247632',	'127830',	'250568',	'I18665',	'190340',	'I18663',	'287306',	'216868',	'331808',	'304420',	'259202',	'302427',	'195215',	'I03457',	'131310',	'305579',	'130760',	'305954',	'286837',	'130490',	'265990',	'106621',	'370570',	'216927',	'313034',	'262081',	'328925',	'17700',	'130790',	'283047',	'I25636',	'271606',	'130705',	'I18675',	'130825',	'130840',	'130875',	'134680',	'195207',	'48590',	'307998',	'314239',	'315893',	'210404',	'144185',	'256550',	'289240',	'204512',	'207206',	'130700',	'210559',	'153815',	'144955') and extract(year from foc.order_placed_at) in ( 2020,2021) group by 1,2,3 order by 1,2; '''
#Omez Analysis - Flip Query
omez_flip_query = '''select year_no, month_no, sum(final_atc_gmv) as final_atc_gmv, sum(atc_gmv) as atc_gmv, sum(quantity) as quantity from ( select extract(year from created_at_ist)as year_no, extract(month from created_at_ist)as month_no, sum(final_atc_gmv)*.85 as final_atc_gmv, sum(atc_gmv)*.85 as atc_gmv, sum(round(atc_gmv/atc_mrp::float,0))*.85 as quantity from reporting_batch.final_data_consumer as fc where fc.atc_product_id in (8576,8619,173904,8599,197843,8579,8577,8583,8582,8580) and order_place_flag = TRUE and flip_option_opted = 'brand' and atc_flag = 1 and brand_options_shown = 'true' and fc.product_substitute_group_id is not null and fc.created_at_ist between '2020-08-01' and (CURRENT_DATE-1) group by 1,2 union all select extract(year from subs_date)as year_no, extract(month from subs_date)as month_no, sum(final_atc_gmv) as final_atc_gmv, sum(atc_gmv)as atc_gmv, sum(quantity) as quantity from reporting_batch.final_data_docstat as fd left join data_model.f_order as ford on fd.order_id = ford.order_id where fd.atc_product_id in (8576,8619,173904,8599,197843,8579,8577,8583,8582,8580) and fd.flip_selected_flag = 1 and fd.product_substitute_group_id is not null and fd.subs_date between '2020-08-01' and (CURRENT_DATE-1) and ford.order_status_id in (9,10) group by 1,2 union all select extract(year from subs_date)as year_no, extract(month from subs_date)as month_no, sum(atc_gmv) as final_atc_gmv, sum(atc_gmv)as atc_gmv, sum(atc_full_quantity) as quantity from reporting_batch.flip_cc_final_data as cco where cco.atc_product_id in (8576,8619,173904,8599,197843,8579,8577,8583,8582,8580) and log_type = 'flip_selected' and substitute_type = 'brand' and order_fulfill_flag = 1 and cco.product_substitute_group_id is not null and cco.subs_date between '2020-08-01' and (CURRENT_DATE-1) group by 1,2 union all select extract(year from subs_date)as year_no, extract(month from subs_date)as month_no, sum(atc_gmv) as final_atc_gmv, sum(atc_gmv)as atc_gmv, sum(atc_full_quantity) as quantity from reporting_batch.flip_cc_rx_final_data as ccr where ccr.atc_product_id in (8576,8619,173904,8599,197843,8579,8577,8583,8582,8580) and log_type = 'flip_selected' and substitute_type = 'brand' and order_fulfill_flag = 1 and ccr.product_substitute_group_id is not null and ccr.subs_date between '2020-08-01' and (CURRENT_DATE-1) group by 1,2 union all select extract(year from subs_date)as year_no, extract(month from subs_date)as month_no, sum(atc_gmv) as final_atc_gmv, sum(atc_gmv)as atc_gmv, sum(atc_full_quantity) as quantity from reporting_batch.flip_ooc_final_data as ooc left join data_model.f_order as ford on ooc.order_id = ford.order_id where ooc.atc_product_id in (8576,8619,173904,8599,197843,8579,8577,8583,8582,8580) and log_type = 'flip_added_to_cart' and substitute_type = 'brand' and ford.order_status_id in (9,10) and ooc.product_substitute_group_id is not null and ooc.subs_date between '2020-08-01' and (CURRENT_DATE-1) group by 1,2 )a group by 1,2;'''
#Competitor Analysis - Flip Query
comp_flip_query = '''select year_no, month_no, sum(final_atc_gmv) as final_atc_gmv, sum(atc_gmv) as atc_gmv, sum(quantity) as quantity from ( select extract(year from created_at_ist)as year_no, extract(month from created_at_ist)as month_no, sum(final_atc_gmv)*.85 as final_atc_gmv, sum(atc_gmv)*.85 as atc_gmv, sum(round(atc_gmv/atc_mrp::float,0))*.85 as quantity from reporting_batch.final_data_consumer as fc where fc.atc_product_id in (80495,197831,194055,4155,65336,97020,93347,230345,56598,60851,103074,56416,197817,76597,67204,98927,1241,169656,56406,1274,113413,56407,197840,197818,107434,1178,95185,197842,121718,109908,2541,2772,102043,212024,165819,3903,3499,4141,3636,107435,3635,4968,4311,145690,4402,200188,127399,5039,53830,5109,197822,5099,52977,56411,5110,102709,5875,5879,110674,23285,6163,9081,2975023,3010930,173904,115932,164812,6075,128670,8576,127344,56218,128817,214954,52908,73428,8577,6873,6584,6162,120906,7538,129196,8580,188990,117385,73050,131707,10271,174230,65370,132912,114013,141328,215220,167848,8578,8581,170687,8884,69982,8599,8933,71666,108353,167297,58389,130530,138856,71674,14408,73915,197824,119385,13230,197820,57050,189716,67198,136091,111070,16018,17958,197837,56600,151213,71675,166046,15680,128266,19646,84540,161602,56404,143269,144314,71775,18167,56402,95496,56400,197844,20550,74676,188895,74463,133161,121688,19410,111344,197833,53187,18304,70553,21009,22003,68672,59888,197845,56387,21395,5809,59886,23119,26084,70554,23087,56388,147775,215568,22457,56397,164737,171386,23901,192741,63340,176041,24514,23118,127852,151306,58700,77003,58400,58663,85374,24472,29121,157911,197841,154663,152466,153965,69966,166725,29906,56429,30009,96495,83101,30809,112366,5617,5392,29270,138885,30806,198265,104692,197832,144637,56353,126987,197846,197813,64504,30805,223983,5634,56351,3045380,194362,87167,98116,197819,197829,197838,5393,105038,29575,218985,29995,27069,111948,124447) and order_place_flag = TRUE and flip_option_opted = 'brand' and atc_flag = 1 and brand_options_shown = 'true' and fc.product_substitute_group_id is not null and fc.created_at_ist between '2020-08-01' and (CURRENT_DATE-1) group by 1,2 union all select extract(year from subs_date)as year_no, extract(month from subs_date)as month_no, sum(final_atc_gmv) as final_atc_gmv, sum(atc_gmv)as atc_gmv, sum(quantity) as quantity from reporting_batch.final_data_docstat as fd left join data_model.f_order as ford on fd.order_id = ford.order_id where fd.atc_product_id in (80495,197831,194055,4155,65336,97020,93347,230345,56598,60851,103074,56416,197817,76597,67204,98927,1241,169656,56406,1274,113413,56407,197840,197818,107434,1178,95185,197842,121718,109908,2541,2772,102043,212024,165819,3903,3499,4141,3636,107435,3635,4968,4311,145690,4402,200188,127399,5039,53830,5109,197822,5099,52977,56411,5110,102709,5875,5879,110674,23285,6163,9081,2975023,3010930,173904,115932,164812,6075,128670,8576,127344,56218,128817,214954,52908,73428,8577,6873,6584,6162,120906,7538,129196,8580,188990,117385,73050,131707,10271,174230,65370,132912,114013,141328,215220,167848,8578,8581,170687,8884,69982,8599,8933,71666,108353,167297,58389,130530,138856,71674,14408,73915,197824,119385,13230,197820,57050,189716,67198,136091,111070,16018,17958,197837,56600,151213,71675,166046,15680,128266,19646,84540,161602,56404,143269,144314,71775,18167,56402,95496,56400,197844,20550,74676,188895,74463,133161,121688,19410,111344,197833,53187,18304,70553,21009,22003,68672,59888,197845,56387,21395,5809,59886,23119,26084,70554,23087,56388,147775,215568,22457,56397,164737,171386,23901,192741,63340,176041,24514,23118,127852,151306,58700,77003,58400,58663,85374,24472,29121,157911,197841,154663,152466,153965,69966,166725,29906,56429,30009,96495,83101,30809,112366,5617,5392,29270,138885,30806,198265,104692,197832,144637,56353,126987,197846,197813,64504,30805,223983,5634,56351,3045380,194362,87167,98116,197819,197829,197838,5393,105038,29575,218985,29995,27069,111948,124447) and fd.flip_selected_flag = 1 and fd.product_substitute_group_id is not null and fd.subs_date between '2020-08-01' and (CURRENT_DATE-1) and ford.order_status_id in (9,10) group by 1,2 union all select extract(year from subs_date)as year_no, extract(month from subs_date)as month_no, sum(atc_gmv) as final_atc_gmv, sum(atc_gmv)as atc_gmv, sum(atc_full_quantity) as quantity from reporting_batch.flip_cc_final_data as cco where cco.atc_product_id in (80495,197831,194055,4155,65336,97020,93347,230345,56598,60851,103074,56416,197817,76597,67204,98927,1241,169656,56406,1274,113413,56407,197840,197818,107434,1178,95185,197842,121718,109908,2541,2772,102043,212024,165819,3903,3499,4141,3636,107435,3635,4968,4311,145690,4402,200188,127399,5039,53830,5109,197822,5099,52977,56411,5110,102709,5875,5879,110674,23285,6163,9081,2975023,3010930,173904,115932,164812,6075,128670,8576,127344,56218,128817,214954,52908,73428,8577,6873,6584,6162,120906,7538,129196,8580,188990,117385,73050,131707,10271,174230,65370,132912,114013,141328,215220,167848,8578,8581,170687,8884,69982,8599,8933,71666,108353,167297,58389,130530,138856,71674,14408,73915,197824,119385,13230,197820,57050,189716,67198,136091,111070,16018,17958,197837,56600,151213,71675,166046,15680,128266,19646,84540,161602,56404,143269,144314,71775,18167,56402,95496,56400,197844,20550,74676,188895,74463,133161,121688,19410,111344,197833,53187,18304,70553,21009,22003,68672,59888,197845,56387,21395,5809,59886,23119,26084,70554,23087,56388,147775,215568,22457,56397,164737,171386,23901,192741,63340,176041,24514,23118,127852,151306,58700,77003,58400,58663,85374,24472,29121,157911,197841,154663,152466,153965,69966,166725,29906,56429,30009,96495,83101,30809,112366,5617,5392,29270,138885,30806,198265,104692,197832,144637,56353,126987,197846,197813,64504,30805,223983,5634,56351,3045380,194362,87167,98116,197819,197829,197838,5393,105038,29575,218985,29995,27069,111948,124447) and log_type = 'flip_selected' and substitute_type = 'brand' and order_fulfill_flag = 1 and cco.product_substitute_group_id is not null and cco.subs_date between '2020-08-01' and (CURRENT_DATE-1) group by 1,2 union all select extract(year from subs_date)as year_no, extract(month from subs_date)as month_no, sum(atc_gmv) as final_atc_gmv, sum(atc_gmv)as atc_gmv, sum(atc_full_quantity) as quantity from reporting_batch.flip_cc_rx_final_data as ccr where ccr.atc_product_id in (80495,197831,194055,4155,65336,97020,93347,230345,56598,60851,103074,56416,197817,76597,67204,98927,1241,169656,56406,1274,113413,56407,197840,197818,107434,1178,95185,197842,121718,109908,2541,2772,102043,212024,165819,3903,3499,4141,3636,107435,3635,4968,4311,145690,4402,200188,127399,5039,53830,5109,197822,5099,52977,56411,5110,102709,5875,5879,110674,23285,6163,9081,2975023,3010930,173904,115932,164812,6075,128670,8576,127344,56218,128817,214954,52908,73428,8577,6873,6584,6162,120906,7538,129196,8580,188990,117385,73050,131707,10271,174230,65370,132912,114013,141328,215220,167848,8578,8581,170687,8884,69982,8599,8933,71666,108353,167297,58389,130530,138856,71674,14408,73915,197824,119385,13230,197820,57050,189716,67198,136091,111070,16018,17958,197837,56600,151213,71675,166046,15680,128266,19646,84540,161602,56404,143269,144314,71775,18167,56402,95496,56400,197844,20550,74676,188895,74463,133161,121688,19410,111344,197833,53187,18304,70553,21009,22003,68672,59888,197845,56387,21395,5809,59886,23119,26084,70554,23087,56388,147775,215568,22457,56397,164737,171386,23901,192741,63340,176041,24514,23118,127852,151306,58700,77003,58400,58663,85374,24472,29121,157911,197841,154663,152466,153965,69966,166725,29906,56429,30009,96495,83101,30809,112366,5617,5392,29270,138885,30806,198265,104692,197832,144637,56353,126987,197846,197813,64504,30805,223983,5634,56351,3045380,194362,87167,98116,197819,197829,197838,5393,105038,29575,218985,29995,27069,111948,124447) and log_type = 'flip_selected' and substitute_type = 'brand' and order_fulfill_flag = 1 and ccr.product_substitute_group_id is not null and ccr.subs_date between '2020-08-01' and (CURRENT_DATE-1) group by 1,2 union all select extract(year from subs_date)as year_no, extract(month from subs_date)as month_no, sum(atc_gmv) as final_atc_gmv, sum(atc_gmv)as atc_gmv, sum(atc_full_quantity) as quantity from reporting_batch.flip_ooc_final_data as ooc left join data_model.f_order as ford on ooc.order_id = ford.order_id where ooc.atc_product_id in (80495,197831,194055,4155,65336,97020,93347,230345,56598,60851,103074,56416,197817,76597,67204,98927,1241,169656,56406,1274,113413,56407,197840,197818,107434,1178,95185,197842,121718,109908,2541,2772,102043,212024,165819,3903,3499,4141,3636,107435,3635,4968,4311,145690,4402,200188,127399,5039,53830,5109,197822,5099,52977,56411,5110,102709,5875,5879,110674,23285,6163,9081,2975023,3010930,173904,115932,164812,6075,128670,8576,127344,56218,128817,214954,52908,73428,8577,6873,6584,6162,120906,7538,129196,8580,188990,117385,73050,131707,10271,174230,65370,132912,114013,141328,215220,167848,8578,8581,170687,8884,69982,8599,8933,71666,108353,167297,58389,130530,138856,71674,14408,73915,197824,119385,13230,197820,57050,189716,67198,136091,111070,16018,17958,197837,56600,151213,71675,166046,15680,128266,19646,84540,161602,56404,143269,144314,71775,18167,56402,95496,56400,197844,20550,74676,188895,74463,133161,121688,19410,111344,197833,53187,18304,70553,21009,22003,68672,59888,197845,56387,21395,5809,59886,23119,26084,70554,23087,56388,147775,215568,22457,56397,164737,171386,23901,192741,63340,176041,24514,23118,127852,151306,58700,77003,58400,58663,85374,24472,29121,157911,197841,154663,152466,153965,69966,166725,29906,56429,30009,96495,83101,30809,112366,5617,5392,29270,138885,30806,198265,104692,197832,144637,56353,126987,197846,197813,64504,30805,223983,5634,56351,3045380,194362,87167,98116,197819,197829,197838,5393,105038,29575,218985,29995,27069,111948,124447) and log_type = 'flip_added_to_cart' and substitute_type = 'brand' and ford.order_status_id in (9,10) and ooc.product_substitute_group_id is not null and ooc.subs_date between '2020-08-01' and (CURRENT_DATE-1) group by 1,2 )a group by 1,2;'''
# Omez & Competitor Analysis - Dr. Program Query
doctor_program_query = '''SELECT EXTRACT (year from a.order_placed_at ), EXTRACT (month from a.order_placed_at) as month, count(distinct a.order_id ) overall_orders , count(distinct case when b.ucode in ('130875', '130876', '130885', '130890', '130900', '130905', '196203', 'I00600', 'I06693', 'I18689') then a.order_id end ) as omez_orders , count(distinct case when b.ucode in ('130875', '130876', '130885', '130890', '130900', '130905', '196203', 'I00600', 'I06693', 'I18689') and c.order_status_id in(9,10) then c.order_id end ) as omez_fulfilled_orders , count(distinct case when b.ucode in ('274085', '302217', 'I40963', 'I18670', '278445', '220650', 'I41311', '320527', '206267', '199344', '36821', '300250', '284067', '256947', '219202', '327847', '130990', '130806', '108790', 'I18678', '210722', '288836', '202063', '296574', '176680', '130485', 'U27831', 'I15105', '304089', 'I06693', '325512', '72585', '200270', '268389', '131930', '274045', '271406', 'K86651', '293205', '215227', 'V84647', '160270', '266941', '318467', '130815', '211197', '200266', '280999', '288238', 'I18679', '221767', '269521', '59960', '131925', 'I18688', '287242', 'I40697', '106620', '205196', '330915', '153825', '323272', 'I18677', '244639', '130915', 'I07092', '190580', '202081', '176690', '267864', 'I18664', '258664', '291942', '290692', '299572', 'I18683', '131935', '312938', '202082', '293473', '280964', '143295', '193501', '128109', '269180', 'I14798', '249399', 'I18668', '196203', 'I18687', '316649', '209020', '268677', '257572', '144190', '263591', '267479', '199320', '330276', '224710', '25375', '129715', '130876', '130800', '325837', '197465', 'I09663', '252310', '270854', '106625', '64649', '229086', '130855', '315689', '144730', '218302', '128125', '130820', '247298', '281507', '265907', '258812', '128130', 'I18684', '130890', '199233', '212978', '206001', '130730', '276079', '130780', 'I18691', '287803', '131015', '206111', '130925', '309302', '299604', '128110', 'I19111', '113435', '130880', '130895', 'I04595', '290522', '324065', '207459', '320085', 'I44728', 'I37767', '255918', '255793', '219203', '143210', '195208', 'I18690', '207649', '368881', '271710', '248853', '107145', '288676', '291505', '202217', '19355', '200269', '33055', '327767', 'I05335', 'I18692', 'I18659', '184420', '205658', 'I18666', '382533', '133510', '212295', 'I13486', '128105', 'V31842', '307085', 'T38748', '285263', '329174', '130715', '251441', 'I18686', '262082', '258505', '266943', '205568', '280127', '247632', '127830', '250568', 'I18665', '190340', 'I18663', '287306', '216868', '331808', '304420', '259202', '302427', '195215', 'I03457', '131310', '305579', '130760', '305954', '286837', '130490', '265990', '106621', '370570', '216927', '313034', '262081', '328925', '17700', '130790', '283047', 'I25636', '271606', '130705', 'I18675', '130825', '130840', '130875', '134680', '195207', '48590', '307998', '314239', '315893', '210404', '144185', '256550', '289240', '204512', '207206', '130700', '210559', '153815', '144955') then a.order_id end ) as competitor_orders, count( distinct case when b.ucode in ('274085', '302217', 'I40963', 'I18670', '278445', '220650', 'I41311', '320527', '206267', '199344', '36821', '300250', '284067', '256947', '219202', '327847', '130990', '130806', '108790', 'I18678', '210722', '288836', '202063', '296574', '176680', '130485', 'U27831', 'I15105', '304089', 'I06693', '325512', '72585', '200270', '268389', '131930', '274045', '271406', 'K86651', '293205', '215227', 'V84647', '160270', '266941', '318467', '130815', '211197', '200266', '280999', '288238', 'I18679', '221767', '269521', '59960', '131925', 'I18688', '287242', 'I40697', '106620', '205196', '330915', '153825', '323272', 'I18677', '244639', '130915', 'I07092', '190580', '202081', '176690', '267864', 'I18664', '258664', '291942', '290692', '299572', 'I18683', '131935', '312938', '202082', '293473', '280964', '143295', '193501', '128109', '269180', 'I14798', '249399', 'I18668', '196203', 'I18687', '316649', '209020', '268677', '257572', '144190', '263591', '267479', '199320', '330276', '224710', '25375', '129715', '130876', '130800', '325837', '197465', 'I09663', '252310', '270854', '106625', '64649', '229086', '130855', '315689', '144730', '218302', '128125', '130820', '247298', '281507', '265907', '258812', '128130', 'I18684', '130890', '199233', '212978', '206001', '130730', '276079', '130780', 'I18691', '287803', '131015', '206111', '130925', '309302', '299604', '128110', 'I19111', '113435', '130880', '130895', 'I04595', '290522', '324065', '207459', '320085', 'I44728', 'I37767', '255918', '255793', '219203', '143210', '195208', 'I18690', '207649', '368881', '271710', '248853', '107145', '288676', '291505', '202217', '19355', '200269', '33055', '327767', 'I05335', 'I18692', 'I18659', '184420', '205658', 'I18666', '382533', '133510', '212295', 'I13486', '128105', 'V31842', '307085', 'T38748', '285263', '329174', '130715', '251441', 'I18686', '262082', '258505', '266943', '205568', '280127', '247632', '127830', '250568', 'I18665', '190340', 'I18663', '287306', '216868', '331808', '304420', '259202', '302427', '195215', 'I03457', '131310', '305579', '130760', '305954', '286837', '130490', '265990', '106621', '370570', '216927', '313034', '262081', '328925', '17700', '130790', '283047', 'I25636', '271606', '130705', 'I18675', '130825', '130840', '130875', '134680', '195207', '48590', '307998', '314239', '315893', '210404', '144185', '256550', '289240', '204512', '207206', '130700', '210559', '153815', '144955') and c.order_status_id in(9,10) then c.order_id end ) as competitor_fulfilled_orders from data_model.f_doctor_program_order a inner join pe_pe2_pe2.medicine_notes b on a.order_id =b.order_id and b.is_deleted =0 and date(a.order_placed_at) >= '2020-01-01' inner join data_model.f_order c on a.order_id =c.order_id where b.ucode in ('274085', '302217', 'I40963', 'I18670', '278445', '220650', 'I41311', '320527', '206267', '199344', '36821', '300250', '284067', '256947', '219202', '327847', '130990', '130806', '108790', 'I18678', '210722', '288836', '202063', '296574', '176680', '130485', 'U27831', 'I15105', '304089', 'I06693', '325512', '72585', '200270', '268389', '131930', '274045', '271406', 'K86651', '293205', '215227', 'V84647', '160270', '266941', '318467', '130815', '211197', '200266', '280999', '288238', 'I18679', '221767', '269521', '59960', '131925', 'I18688', '287242', 'I40697', '106620', '205196', '330915', '153825', '323272', 'I18677', '244639', '130915', 'I07092', '190580', '202081', '176690', '267864', 'I18664', '258664', '291942', '290692', '299572', 'I18683', '131935', '312938', '202082', '293473', '280964', '143295', '193501', '128109', '269180', 'I14798', '249399', 'I18668', '196203', 'I18687', '316649', '209020', '268677', '257572', '144190', '263591', '267479', '199320', '330276', '224710', '25375', '129715', '130876', '130800', '325837', '197465', 'I09663', '252310', '270854', '106625', '64649', '229086', '130855', '315689', '144730', '218302', '128125', '130820', '247298', '281507', '265907', '258812', '128130', 'I18684', '130890', '199233', '212978', '206001', '130730', '276079', '130780', 'I18691', '287803', '131015', '206111', '130925', '309302', '299604', '128110', 'I19111', '113435', '130880', '130895', 'I04595', '290522', '324065', '207459', '320085', 'I44728', 'I37767', '255918', '255793', '219203', '143210', '195208', 'I18690', '207649', '368881', '271710', '248853', '107145', '288676', '291505', '202217', '19355', '200269', '33055', '327767', 'I05335', 'I18692', 'I18659', '184420', '205658', 'I18666', '382533', '133510', '212295', 'I13486', '128105', 'V31842', '307085', 'T38748', '285263', '329174', '130715', '251441', 'I18686', '262082', '258505', '266943', '205568', '280127', '247632', '127830', '250568', 'I18665', '190340', 'I18663', '287306', '216868', '331808', '304420', '259202', '302427', '195215', 'I03457', '131310', '305579', '130760', '305954', '286837', '130490', '265990', '106621', '370570', '216927', '313034', '262081', '328925', '17700', '130790', '283047', 'I25636', '271606', '130705', 'I18675', '130825', '130840', '130875', '134680', '195207', '48590', '307998', '314239', '315893', '210404', '144185', '256550', '289240', '204512', '207206', '130700', '210559', '153815', '144955', '130875', '130876', '130885', '130890', '130900', '130905', '196203', 'I00600', 'I06693', 'I18689' ) group by 1,2 order by 1,2 ; '''
#SKU Analysis - Dr. Program
SKU_doctor_query='''SELECT EXTRACT (year from a.order_placed_at ), EXTRACT (month from a.order_placed_at) as month,ucode,b.medicine_name , count(distinct a.order_id ) orders , count(distinct case when c.order_status_id in(9,10) then c.order_id end ) as omez_fulfilled_orders,round((1.0*omez_fulfilled_orders/orders),5) as conversion_percentage from data_model.f_doctor_program_order a inner join pe_pe2_pe2.medicine_notes b on a.order_id =b.order_id and b.is_deleted =0 and date(a.order_placed_at) >= '2020-01-01' and b.ucode in ('130875', '130876', '130885', '130890', '130900', '130905', '196203', 'I00600', 'I06693', 'I18689') inner join data_model.f_order c on a.order_id =c.order_id group by 1,2,3,4 order by 3,4,1,2 ; '''


#Dataframes
omez_sales = query_fetch(omez_Sales_query,conn)
Comp_sales = query_fetch(comp_sales_query,conn)
omez_flip = query_fetch(omez_flip_query,conn)
comp_flip = query_fetch(comp_flip_query,conn)
doctor_program = query_fetch(doctor_program_query,conn)
SKU_doctor_program = query_fetch(SKU_doctor_query,conn)


#writing into Excel file
writer = pd.ExcelWriter('Omez_DRL_test.xlsx', engine='xlsxwriter')

omez_sales.to_excel(writer, sheet_name='Omez_Sales',index=False)
Comp_sales.to_excel(writer, sheet_name='Competitor_Sales',index=False)
omez_flip.to_excel(writer, sheet_name='Omez_flip',index=False)
comp_flip.to_excel(writer, sheet_name='Competitor_flip',index=False)
doctor_program.to_excel(writer, sheet_name='Omez&Comp_DoctorProgram',index=False)
SKU_doctor_program.to_excel(writer, sheet_name='SKU_DoctorProgram',index=False)

writer.save()
